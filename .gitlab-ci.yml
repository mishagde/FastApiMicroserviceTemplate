stages:
  - build
  - publish

variables:
  DOTNET_VERSION: "8.0"
  NUGET_SERVER: "https://$CI_SERVER_HOST/api/v4/projects/$CI_PROJECT_ID/packages/nuget"

before_script:
  - echo "Using .NET SDK version $DOTNET_VERSION"
  - export PATH="$PATH:$HOME/.dotnet/tools"

build:
  stage: build
  image: mcr.microsoft.com/dotnet/sdk:$DOTNET_VERSION
  rules:
    - if: '$CI_COMMIT_REF_NAME =~ /^release\/.*$/'
      when: always
  script: |
    echo "Installing mono..."
    apt-get update -y
    apt-get install -y --no-install-recommends mono-complete wget
    
    echo "Downloading nuget.exe..."
    wget https://dist.nuget.org/win-x86-commandline/latest/nuget.exe -O nuget.exe
    
    echo "Searching for .nuspec file in project root..."
    NUSPEC_FILE=$(find "$CI_PROJECT_DIR" -maxdepth 1 -name "*.nuspec" | head -1)
    
    if [ -z "$NUSPEC_FILE" ]; then
      echo "❌ ERROR: No .nuspec file found in project root!"
      exit 1
    fi
    
    echo "Found nuspec: $NUSPEC_FILE"
    
    TEMPLATE_VERSION=$(echo "$CI_COMMIT_REF_NAME" | sed 's/release\///')
    echo "Version detected: $TEMPLATE_VERSION"
    
    echo "Packing template..."
    cd "$CI_PROJECT_DIR"
    mono nuget.exe pack "$NUSPEC_FILE" \
      -BasePath "$CI_PROJECT_DIR" \
      -OutputDirectory "$CI_PROJECT_DIR/nupkg" \
      -Properties version=$TEMPLATE_VERSION \
      -NoDefaultExcludes
    
    echo "Package created:"
    ls -la "$CI_PROJECT_DIR/nupkg"

  artifacts:
    paths:
      - nupkg/*.nupkg
    expire_in: never

publish:
  stage: publish
  image: mcr.microsoft.com/dotnet/sdk:$DOTNET_VERSION
  rules:
    - if: '$CI_COMMIT_REF_NAME =~ /^release\/.*$/'
      when: on_success
  script: |
    ls -la ./nupkg
    dotnet nuget push ./nupkg/*.nupkg --source $NUGET_SERVER --api-key $CI_JOB_TOKEN
